#!/usr/bin/zsh -ex

if [ $(id -u) != 0 ]; then
  echo Run as root.
  exit
fi

cd $(dirname $0)

source roofix.conf

CRYPTNAME=root$RANDOM
TARGET=$(mktemp -d)

# ensure there's a connection
ping google.com -c 1 > /dev/null

if [ -f $DEVICE -o ! -e $DEVICE ]; then
  IMAGE=$DEVICE
  DEVICE=/dev/loop7
else
  # ensure it's not mounted.
  ! mount | grep -q $DEVICE
fi

# usage:
# add_files /boot/extlinux.conf KERNEL_ARGS='blah blah blah'
# add_files /usr/share/slim/ ONE_VAR=something 'ANOTHER_VAR=and so on'
add_files() {
  (
    pushd templates
      root_dir=$1
      shift
      # copy then overwrite to preserve permissions
      cp -Taf ./$root_dir $TARGET/$root_dir
      find ./$root_dir | while read filename; do
        if [ -f $filename ]; then
          for i in $@; do echo $i; done | python -c "
import string
import sys
mapping={}
for x in sys.stdin.readlines():
  if '=' in x:
    (frm, to) = x.strip().split('=',1)
    mapping[frm] = to
data = open('$filename','rb').read()
if mapping == {}:
  sys.stdout.buffer.write(data)
else:
  template = string.Template(data.decode())
  sys.stdout.write(template.safe_substitute(mapping))" > $TARGET/$filename
        fi
      done
    popd
  )
}

# runs in the chroot
run() {
  arch-chroot $TARGET $@
}

find roofix.d | sort | while read script; do
  [ -f $script ] && source $script
done

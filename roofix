#!/usr/bin/zsh -ex

if [ $(id -u) != 0 ]; then
  echo Run as root.
  exit
fi

cd $(dirname $0)

source roofix.conf

CRYPTNAME=root$RANDOM
TARGET=$(mktemp -d)

# ensure there's a connection
ping google.com -c 1 > /dev/null

if [ -f $DEVICE -o ! -e $DEVICE ]; then
  IMAGE=$DEVICE
  DEVICE=/dev/loop7
else
  # ensure it's not mounted.
  ! mount | grep -q $DEVICE
fi

find roofix.d | sort | while read script; do
  [ -f $script ] && source $script
done
